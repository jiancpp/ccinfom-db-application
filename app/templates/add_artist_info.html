{% extends "base.html" %}
{% block title %} Create New Artist - KSync {% endblock %}

{% block content %}
    <style>
        /* CSS is kept brief here for clarity; assume existing styles are in place */
        .header-title {
            color: #667eea; 
            font-size: 2.5rem; 
            margin-bottom: 5px;
        }

        /* Card for the Member section */
        .member-card {
            background-color: #f9f9ff;
            border: 1px solid #e9e9ff;
        }

        /* Style for the individual member input rows */
        .member-row {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            align-items: flex-end; /* Align inputs and button */
        }
        
        .member-row:last-of-type {
            border-bottom: none;
        }

        /* NEW: Grid container for the 6 member inputs */
        .member-input-group {
            flex-grow: 1;
            display: grid;
            /* Create 3 columns. Repeat 1fr twice to force 2 rows */
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
        }
        
        /* Ensures the label is above the input */
        .member-input-group > div {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .member-input-group label {
            font-size: 0.85rem;
            color: #777;
            margin-bottom: 3px;
            display: block;
        }
        
        /* Delete button styling */
        .btn-delete {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            height: 38px; /* Match input height */
            flex-shrink: 0;
        }
        
        .btn-add-member {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 6px;
            width: 100%;
            margin-top: 15px;
        }

    </style>

    <header style="border-bottom: 3px solid #667eea; padding-bottom: 10px; margin-bottom: 25px;">
        <h1 class="header-title">
            <i class="fa fa-users"></i> Create New Artist
        </h1>
        <p style="color: #555;">
            All fields marked with * are required.
        </p>
    </header>

    <form method="POST" action="{{ url_for('main_routes.add_artist') }}">
        
        <div class="grid" style="grid-template-columns: 1fr 1.5fr; gap: 20px;">
            
            {# --- LEFT COLUMN: ARTIST CORE DETAILS --- #}
            <div>
            <div class="card">
                <h3 style="color: #4a4a4a; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
                    Artist Information
                </h3>

                <div class="form-group">
                    <label for="artist_name">Artist Name *</label>
                    <input type="text" id="artist_name" name="artist_name" required placeholder="e.g., KSync, BLACKPINK">
                </div>

                <div class="form-group grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label for="debut_date">Debut Date *</label>
                        <input type="date" id="debut_date" name="debut_date" required>
                    </div>
                    <div>
                        <label for="activity_status">Activity Status *</label>
                        <select id="activity_status" name="activity_status" required>
                            <option value="Active">Active</option>
                            <option value="Hiatus">Hiatus</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Disbanded">Disbanded</option>
                        </select>
                    </div>
                </div>

            </div>

            {# === NEW: MANAGER DETAILS CARD === #}
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="color: #4a4a4a; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
                        <i class="fa fa-briefcase"></i> Add Manager Details
                    </h3>
                    
                    <div class="form-group">
                        <label for="agency_name">Agency Name</label>
                        <input type="text" id="agency_name" name="agency_name" placeholder="e.g., KSync Entertainment">
                    </div>

                    <div class="form-group">
                        <label for="new_manager_name">Manager Contact Name</label>
                        <input type="text" id="new_manager_name" name="new_manager_name" placeholder="Manager's Full Name">
                    </div>

                    <div class="form-group grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label for="new_manager_phone">Contact Number</label>
                            <input type="tel" id="new_manager_phone" name="new_manager_phone" placeholder="e.g., +1-555-1234">
                        </div>
                        <div>
                            <label for="new_manager_email">Email Address</label>
                            <input type="email" id="new_manager_email" name="new_manager_email" placeholder="manager@agency.com">
                        </div>
                    </div>
                </div>
            </div>

            {# --- RIGHT COLUMN CONTAINER --- #}
            <div>
                {# === EXISTING: ARTIST MEMBERS CARD (Uses the updated member row) === #}
                <div class="card member-card">
                    <h3 style="color: #4a4a4a; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
                        Artist Members
                    </h3>
                    
                    <div id="members-container">
                        <!-- Dynamic member rows will be here -->
                    </div>

                    <button type="button" class="btn-add-member" onclick="addMemberRow()">
                        <i class="fa fa-plus-circle"></i> Add New Member
                    </button>
                </div>

            </div>
        </div>
        
        <div class="form-group" style="margin-top: 30px; text-align: center;">
            <button type="submit" class="btn" style="background-color: #764ba2; width: 50%; max-width: 300px; padding: 12px; font-size: 1.1rem;">
                <i class="fa fa-music"></i> Create Artist
            </button>
        </div>

    </form>
{% endblock %}

{% block scripts %}
<script>
    let memberCount = 0;
    
    const availableRoles = {{roles | tojson}};
    const availableNationalities = {{nationalities | tojson}};

    /**
     * Helper function to convert an array of objects to <option> HTML string
     */
    function generateOptionsHTML(optionsArray) {
        return optionsArray.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('');
    }

function getMemberRowHTML(index) {
    // Generate options dynamically from JS variables (which Jinja populates)
    const roleOptions = generateOptionsHTML(availableRoles);
    const nationalityOptions = generateOptionsHTML(availableNationalities);

    return `
        <div class="member-row" id="member-row-${index}">
            <div class="member-input-group">
                
                <div>
                    <label for="member_name_${index}">Member Name *</label>
                    <input type="text" id="member_name_${index}" name="members[${index}][name]" placeholder="Real Name or Stage Name" required>
                </div>
                
                <div>
                    <label for="member_birth_date_${index}">Birth Date</label>
                    <input type="date" id="member_birth_date_${index}" name="members[${index}][birth_date]">
                </div>

                <div>
                    <label for="member_status_${index}">Status</label>
                    <select id="member_status_${index}" name="members[${index}][activity_status]">
                        <option value="Active">Active</option>
                        <option value="Hiatus">Hiatus</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>


                <div style="grid-column: span 2;"> 
                    <label for="member_role_${index}">Role(s)</label>
                    <div style="display: flex; gap: 5px; align-items: flex-start;">
                        <select id="member_role_${index}" name="members[${index}][role]" multiple style="height: 38px; flex-grow: 1;">
                            ${roleOptions}
                        </select>
                        <button type="button" class="btn-sm btn-add-ref" 
                                onclick="addNewValue('Role', ${index})"
                                title="Add a new Role">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: #888; margin-top: 2px;">
                        Hold CTRL/CMD to select multiple.
                    </p>
                </div>

                <div>
                    <label for="member_nationality_${index}">Nationality</label>
                    <div style="display: flex; gap: 5px; align-items: flex-start;">
                        <select id="member_nationality_${index}" name="members[${index}][nationality]" multiple style="height: 38px; flex-grow: 1;">
                            ${nationalityOptions}
                        </select>
                        <button type="button" class="btn-sm btn-add-ref" 
                                onclick="addNewValue('Nationality', ${index})"
                                title="Add a new Nationality">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: #888; margin-top: 2px;">
                        Hold CTRL/CMD to select multiple.
                    </p>
                </div>

            </div>
            
            <button type="button" class="btn-delete" onclick="removeMemberRow(${index})">
                <i class="fa fa-trash"></i>
            </button>
        </div>
    `;
}

    /**
     * Dummy function to simulate adding a new role/nationality.
     * In a real application, this would open a modal, submit via AJAX, 
     * and update the database/dropdown.
     */
    function addNewValue(type, index) {
        const newValue = prompt(`Enter the new ${type} to add:`);
        if (newValue && newValue.trim() !== "") {
            alert(`New ${type} "${newValue.trim()}" would be processed and added to the database.`);
            // You would then typically refresh the options in the select field
            // or automatically select the new value if successfully added.
        }
    }

    /**
     * Adds a new member row to the container.
     */
    function addMemberRow() {
        const container = document.getElementById('members-container');
        const newRowHTML = getMemberRowHTML(memberCount);
        container.insertAdjacentHTML('beforeend', newRowHTML);
        memberCount++;
    }

    /**
     * Removes a member row and re-indexes the remaining fields.
     */
    function removeMemberRow(indexToRemove) {
        const row = document.getElementById(`member-row-${indexToRemove}`);
        if (row) {
            row.remove();
        }

        // Re-index remaining fields to ensure sequential array submission
        const container = document.getElementById('members-container');
        const remainingRows = container.querySelectorAll('.member-row');
        
        memberCount = 0; // Reset counter for re-indexing

        remainingRows.forEach((row, newIndex) => {
            // Update row ID
            row.id = `member-row-${newIndex}`;

            // Update input names and IDs
            row.querySelectorAll('input, select').forEach(input => {
                const oldName = input.name;
                // Use a regex replace to update the index inside the brackets
                if (oldName) { // Check if name exists before replacing
                     input.name = oldName.replace(/\[\d+\]/, `[${newIndex}]`);
                }
                input.id = input.id.replace(/_\d+$/, `_${newIndex}`);
            });

            // Update button click handler
            row.querySelector('.btn-delete').setAttribute('onclick', `removeMemberRow(${newIndex})`);

            memberCount = newIndex + 1;
        });

        // Ensure at least one row remains if necessary, or check if the counter is accurate
        if (memberCount === 0) {
            addMemberRow(); // Ensure at least one member field is always present
        }
    }

    // Add an initial member row when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        addMemberRow();
    });
</script>
{% endblock %}